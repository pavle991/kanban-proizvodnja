<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Skener statusa proizvoda</title>

  <!-- Ubrzaj prvi load WebApp-a -->
  <link rel="preconnect" href="https://script.google.com" crossorigin>
  <link rel="preconnect" href="https://googleusercontent.com" crossorigin>
  <link rel="preconnect" href="https://apis.google.com" crossorigin>

  <style>
    :root { color-scheme: light dark; }
    *{box-sizing:border-box}
    body { margin:0; font-family: system-ui,-apple-system,BlinkMacSystemFont,sans-serif; background:#f5f7fb; color:#111; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 14px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    h1 { font-size:1.05rem; margin:0; letter-spacing:.2px; }

    .toolbar { display:flex; gap:8px; width:100%; flex-wrap:wrap; align-items:center; }
    .bar { display:flex; gap:8px; flex:1 1 420px; }
    input[type="text"] { flex:1; padding:10px 12px; font-size:1rem; border-radius:10px; border:1px solid #cfd6e4; background:#fff; }
    button, a.btn { padding:10px 14px; font-size:1rem; border-radius:10px; border:0; background:#2563eb; color:#fff; text-decoration:none; cursor:pointer; }
    button.secondary, a.secondary { background:#e5e7eb; color:#111; }
    .hint { font-size:0.9rem; color:#444; margin:8px 0 0; }

    .frame-wrap { height: calc(100vh - 150px); margin-top: 10px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; position:relative; }
    iframe { width:100%; height:100%; border:0; display:block; }
    .loading { display:none; align-items:center; justify-content:center; gap:8px; position:absolute; inset:0; color:#555; font-size:.95rem; background:
      repeating-linear-gradient(45deg,#fafcff,#fafcff 10px,#f3f6fd 10px,#f3f6fd 20px);
    }
    .spinner{ width:18px; height:18px; border:2px solid #c4d1ef; border-top-color:#2563eb; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin{to{transform:rotate(360deg)}}
    .hidden { display:none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Skener statusa proizvoda</h1>
      <div class="toolbar">
        <div class="bar">
          <input id="codeInput" type="text" placeholder="Unesi šifru (tačno kao u koloni H)" />
          <button id="openBtn" title="Otvori u okviru">Otvori</button>
          <a id="directBtn" class="btn secondary" href="#" target="_blank" rel="noopener">Direktno</a>
        </div>
        <div class="hint">Forma ispod (Apps Script) sadrži padajući meni sa statusima i dugme “Sačuvaj”.</div>
      </div>
    </header>

    <div class="frame-wrap">
      <div id="loading" class="loading"><div class="spinner"></div> <span>Učitavanje forme…</span></div>
      <iframe id="scanFrame" title="Scanner" class="hidden" referrerpolicy="no-referrer"></iframe>
    </div>
  </div>

  <script>
    // Tvoj Web App EXEC URL
    const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbyl5_WP4mLIogkidJiUxugn89XUFgjyboPr2KgA7_AkN-V2qK_xT1Jlo_BuNTEtRZ7Z/exec';

    const $ = s => document.querySelector(s);
    const codeInput = $('#codeInput');
    const openBtn = $('#openBtn');
    const directBtn = $('#directBtn');
    const frame = $('#scanFrame');
    const loading = $('#loading');

    // “Zagrej” WebApp da brže odgovori
    (function keepWarmOnce(){
      try{ fetch(WEBAPP_URL + '?health=1', { mode:'no-cors', cache:'no-store' }); }catch(_){}
    })();
    setInterval(()=>{ try{ fetch(WEBAPP_URL + '?health=1', { mode:'no-cors' }); }catch(_){} }, 240000);

    function getParam(name){
      const u=new URL(window.location.href);
      return u.searchParams.get(name);
    }
    function setParam(name,val){
      const u=new URL(window.location.href);
      if (val==null) u.searchParams.delete(name); else u.searchParams.set(name,val);
      history.replaceState(null,'',u.toString());
    }
    function currentCode(){
      return (codeInput.value||'').trim().replace(/\s+/g,' ');
    }
    function buildScanUrl(code){
      return WEBAPP_URL + '?code=' + encodeURIComponent(code);
    }
    function setDirectLink(url){ directBtn.href = url; }
    function showInFrame(url){
      loading.style.display = 'flex';
      frame.classList.add('hidden');
      // fallback u slučaju da onload ne “pali” zbog third-party domena
      let timer = setTimeout(()=>{
        loading.style.display = 'none';
        frame.classList.remove('hidden');
      }, 2500);
      frame.onload = () => { clearTimeout(timer); loading.style.display='none'; frame.classList.remove('hidden'); };
      frame.src = url;
    }

    // Init iz URL-a
    (function init(){
      const code = (getParam('code') || getParam('product_code') || '').trim();
      if (code){
        codeInput.value = code;
        const scanUrl = buildScanUrl(code);
        setDirectLink(scanUrl);
        showInFrame(scanUrl);
      }
    })();

    // Otvori
    openBtn.addEventListener('click', ()=>{
      const code = currentCode();
      if (!code){ alert('Upiši šifru proizvoda (tačno kao u koloni H).'); return; }
      const url = buildScanUrl(code);
      setDirectLink(url);
      showInFrame(url);
      setParam('code', code);
    });

    // Enter u polju
    codeInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') openBtn.click(); });
  </script>
</body>
</html>