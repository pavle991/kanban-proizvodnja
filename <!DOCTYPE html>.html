<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Skener statusa proizvoda</title>
  <style>
    :root { color-scheme: light dark; }
    body { margin:0; font-family: system-ui,-apple-system,BlinkMacSystemFont,sans-serif; background:#f5f7fb; color:#111; }
    .wrap { max-width: 900px; margin: 0 auto; padding: 12px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    h1 { font-size:1.1rem; margin:0; }
    .bar { display:flex; gap:8px; width:100%; }
    input[type="text"] { flex:1; padding:10px 12px; font-size:1rem; border-radius:8px; border:1px solid #cfd6e4; }
    button, a.btn { padding:10px 14px; font-size:1rem; border-radius:8px; border:0; background:#2563eb; color:#fff; text-decoration:none; cursor:pointer; }
    button.secondary, a.secondary { background:#e5e7eb; color:#111; }
    .info { font-size:0.9rem; color:#444; margin:8px 0 0; }
    .frame-wrap { height: calc(100vh - 120px); margin-top: 10px; background:#fff; border:1px solid #e5e7eb; border-radius:10px; overflow:hidden; }
    iframe { width:100%; height:100%; border:0; }
    .loading { display:none; align-items:center; justify-content:center; height:100%; color:#666; font-size:0.95rem; }
    .hidden { display:none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Skener statusa proizvoda</h1>
    </header>

    <div class="bar">
      <input id="codeInput" type="text" placeholder="Unesi šifru proizvoda (npr. Suknja SS 25/323)" />
      <button id="openBtn">Otvori</button>
      <a id="directBtn" class="btn secondary" href="#" target="_blank" rel="noopener">Direktno</a>
    </div>
    <div class="info">Možeš i direktno da otvoriš: link prihvata <code>?code=...</code> ili <code>?product_code=...</code>.</div>

    <div class="frame-wrap">
      <div id="loading" class="loading">Učitavanje forme…</div>
      <iframe id="scanFrame" title="Scanner" class="hidden"></iframe>
    </div>
  </div>

  <script>
    // Tvoj Apps Script Web App URL (EXEC)
    const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbyl5_WP4mLIogkidJiUxugn89XUFgjyboPr2KgA7_AkN-V2qK_xT1Jlo_BuNTEtRZ7Z/exec';

    const $ = sel => document.querySelector(sel);
    const codeInput = $('#codeInput');
    const openBtn = $('#openBtn');
    const directBtn = $('#directBtn');
    const frame = $('#scanFrame');
    const loading = $('#loading');

    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }
    function currentCode() {
      return (codeInput.value || '').trim();
    }
    function buildScanUrl(code) {
      return WEBAPP_URL + '?action=scan&product_code=' + encodeURIComponent(code);
    }
    function showInFrame(url) {
      loading.style.display = 'flex';
      frame.classList.add('hidden');
      frame.onload = () => {
        loading.style.display = 'none';
        frame.classList.remove('hidden');
      };
      frame.src = url;
    }
    function setDirectLink(url) {
      directBtn.href = url;
    }

    // Init from URL (?code=… ili ?product_code=…)
    (function init() {
      const code = getQueryParam('code') || getQueryParam('product_code');
      if (code) {
        codeInput.value = code;
        const scanUrl = buildScanUrl(code);
        setDirectLink(scanUrl);
        showInFrame(scanUrl);
      }
    })();

    // Dugme "Otvori"
    openBtn.addEventListener('click', () => {
      const code = currentCode();
      if (!code) { alert('Upiši šifru proizvoda.'); return; }
      const scanUrl = buildScanUrl(code);
      setDirectLink(scanUrl);
      showInFrame(scanUrl);
      // update URL (bez reloada)
      const u = new URL(window.location.href);
      u.searchParams.set('code', code);
      history.replaceState(null, '', u.toString());
    });

    // Enter u inputu
    codeInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') openBtn.click();
    });
  </script>
</body>
</html>