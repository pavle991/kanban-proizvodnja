<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="utf-8" />
  <title>Kanban proizvodnje</title>
  <meta http-equiv="refresh" content="600">
  <style>
    html { font-size: 14px; }
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; margin:0; padding:10px; background:#f0f2f5; }
    h2 { margin-top:0; font-size:1.5rem; }
    .controls { margin-bottom:8px; }
    .controls button { padding:6px 12px; font-size:0.9rem; }
    .status-banner { display:inline-block; padding:6px 10px; margin-left:8px; border-radius:6px; background:#e6f7ff; border:1px solid #40a9ff; font-size:1rem; vertical-align:middle; }
    .board-wrapper { width:100%; height: calc(100vh - 200px); overflow:hidden; }
    .board { display: flex; gap:8px; transform-origin: top left; }
    .column { flex:1; background:#e8eef5; border-radius:6px; display:flex; flex-direction:column; padding:6px; }
    .col-header { font-weight: bold; margin-bottom:4px; flex:0 0 auto; font-size:0.9rem; }
    .col-header-top { display:flex; justify-content: space-between; align-items: baseline; }
    .cards { flex:1; }
    .card {
      background:#fff; border-radius:6px; padding:6px; margin-bottom:6px;
      box-shadow:0 1px 3px rgba(0,0,0,0.1); position: relative; cursor:pointer;
      color:#1f2937; font-size:0.85rem; display:flex; align-items:center;
      justify-content:center; height:40px;
    }
    .slikano-badge {
      position:absolute; top:4px; left:4px; display:flex; align-items:center;
      gap:4px; background:rgba(255,255,255,0.9); padding:2px 6px; border-radius:999px;
      font-size:0.75rem; font-weight:600;
    }
    .slikano-dot { width:8px; height:8px; border-radius:50%; background:#28a745; display:inline-block; margin-right:4px; }
    .small { font-size:0.75rem; color:#222; margin-left:4px; }
    .modal {
      position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);
      display:flex; align-items:center; justify-content:center; z-index:10;
    }
    .modal-content {
      background:#fff; border-radius:6px; padding:16px; width:90%; max-width:600px;
      position: relative; box-shadow:0 8px 20px rgba(0,0,0,0.1); font-size:0.85rem;
    }
    .close { position:absolute; top:8px; right:8px; cursor:pointer; font-size:1.2rem; }
    .urgent { outline: 2px solid #ff9f1a; }
    .done { opacity:0.8; }
    #consoleLog {
      background:#000; color:#0f0; font-family:monospace; padding:8px;
      margin-top:8px; height:120px; overflow:auto; white-space:pre-wrap;
      border-radius:4px; border:1px solid #333;
    }
  </style>
</head>
<body>
  <h2>Kanban proizvodnje</h2>
  <div class="controls">
    <button id="reloadBtn">Uƒçitaj ponovo</button>
    <span class="status-banner" id="status-banner">Uƒçitavanje‚Ä¶</span>
  </div>
  <div class="board-wrapper">
    <div class="board" id="board">
      <div class="column" data-status="Proizvodnja">
        <div class="col-header">
          <div class="col-header-top">
            <div>Proizvodnja</div>
            <div class="column-count" id="count-Proizvodnja"></div>
          </div>
          <div class="summary" id="summary-Proizvodnja"></div>
          <div class="breakdown" id="breakdown-Proizvodnja"></div>
        </div>
        <div class="cards"></div>
      </div>
      <div class="column" data-status="Vez">
        <div class="col-header">
          <div class="col-header-top">
            <div>Vez</div>
            <div class="column-count" id="count-Vez"></div>
          </div>
          <div class="summary" id="summary-Vez"></div>
          <div class="breakdown" id="breakdown-Vez"></div>
        </div>
        <div class="cards"></div>
      </div>
      <div class="column" data-status="Pakovanje">
        <div class="col-header">
          <div class="col-header-top">
            <div>Pakovanje</div>
            <div class="column-count" id="count-Pakovanje"></div>
          </div>
          <div class="summary" id="summary-Pakovanje"></div>
          <div class="breakdown" id="breakdown-Pakovanje"></div>
        </div>
        <div class="cards"></div>
      </div>
      <div class="column" data-status="Magacin">
        <div class="col-header">
          <div class="col-header-top">
            <div>Magacin</div>
            <div class="column-count" id="count-Magacin"></div>
          </div>
          <div class="summary" id="summary-Magacin"></div>
          <div class="breakdown" id="breakdown-Magacin"></div>
        </div>
        <div class="cards"></div>
      </div>
      <div class="column" data-status="Nedefinisano">
        <div class="col-header">
          <div class="col-header-top">
            <div>Nedefinisano</div>
            <div class="column-count" id="count-Nedefinisano"></div>
          </div>
          <div class="summary" id="summary-Nedefinisano"></div>
          <div class="breakdown" id="breakdown-Nedefinisano"></div>
        </div>
        <div class="cards"></div>
      </div>
    </div>
  </div>

  <pre id="consoleLog">--- console log ---</pre>
  <div id="modal" style="display:none;"></div>

  <script>
    var endpoint = "https://script.google.com/macros/s/AKfycbwhKEBafSBhrjNYc5oAosp6kRW4q0aInuTBt-tAZKdXARZskavi1qJdYWJRuLLRZnpTmw/exec";
    var logEl = document.getElementById('consoleLog');
    function log(msg) {
      logEl.textContent += "\n" + msg;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function fetchAndRender() {
      log('Starting fetch...');
      document.getElementById('status-banner').textContent = 'Uƒçitavanje...';
      try {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', endpoint + '?_=' + Date.now(), true);
        xhr.onload = function() {
          log('XHR status: ' + xhr.status);
          if (xhr.status === 200) {
            try {
              var data = JSON.parse(xhr.responseText);
              log('Parsed items: ' + (data.items ? data.items.length : 0));
              renderBoard(data);
              document.getElementById('status-banner').textContent = 'Uƒçitano ' + (data.items ? data.items.length : 0) + ' proizvoda.';
            } catch (e) {
              log('Parse error: ' + e.message);
              document.getElementById('status-banner').textContent = 'Gre≈°ka parsiranja';
            }
          } else {
            log('Non-200 status: ' + xhr.status);
            document.getElementById('status-banner').textContent = 'Gre≈°ka status: ' + xhr.status;
          }
        };
        xhr.onerror = function() {
          log('XHR error');
          document.getElementById('status-banner').textContent = 'Gre≈°ka XHR';
        };
        xhr.send();
      } catch (err) {
        log('Exception: ' + err.message);
      }
    }

    function renderBoard(data) {
      var statuses = ['Proizvodnja','Vez','Pakovanje','Magacin','Nedefinisano'];
      var counts = {}, totalIskrojeno = {}, slikanCount = {}, breakdown = {};
      var placed = {};
      statuses.forEach(function(s) {
        counts[s] = 0;
        totalIskrojeno[s] = 0;
        slikanCount[s] = 0;
        breakdown[s] = {};
        document.querySelector('[data-status="'+s+'"] .cards').innerHTML = '';
        document.getElementById('count-'+s).textContent = '';
        document.getElementById('summary-'+s).textContent = '';
        document.getElementById('breakdown-'+s).textContent = '';
      });
      data.items.forEach(function(item) {
        var status = (item.status && item.status.trim()) ? item.status.trim() : 'Nedefinisano';
        if (!counts.hasOwnProperty(status)) status = 'Nedefinisano';
        if (placed[item.product_code]) return;
        placed[item.product_code] = true;
        counts[status]++;
        totalIskrojeno[status] += Number(item.iskrojeno) || 0;
        if (item.slikan) slikanCount[status]++;
        var prod = item.proizvodnja || 'Nepoznato';
        breakdown[status][prod] = (breakdown[status][prod]||0) + (Number(item.iskrojeno)||0);

        var card = document.createElement('div');
        card.className = 'card';
        if (item.proizvodnja) card.style.background = colorFromString(item.proizvodnja);
        if (status === 'Magacin') card.classList.add('done');
        if (item.alert) card.classList.add('urgent');

        var nameEl = document.createElement('div');
        var icon = item.slikan ? 'üì∑' : 'üö´üì∑';
        var days = item.days_since_publish || 0;
        nameEl.innerHTML = icon + ' <strong>' + item.name + '</strong><span class="small">' + days + 'd</span>';
        card.appendChild(nameEl);

        card.onclick = function() { showModal(item); };
        document.querySelector('[data-status="'+status+'"] .cards').appendChild(card);
      });
      adjustScale();
      statuses.forEach(function(s) {
        document.getElementById('count-'+s).textContent = '('+counts[s]+')';
        document.getElementById('summary-'+s).textContent = 'Ukupno iskrojeno: '+ totalIskrojeno[s] +', Slikano: '+ slikanCount[s];
        var parts = [];
        for (var p in breakdown[s]) parts.push(p+': '+breakdown[s][p]);
        document.getElementById('breakdown-'+s).textContent = parts.join(' ‚Ä¢ ');
      });
    }

    function colorFromString(str) {
      var hash = 0;
      for (var i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
        hash &= hash;
      }
      var h = Math.abs(hash) % 360;
      return 'hsl('+h+',55%,85%)';
    }

    function adjustScale() {
      var wrapper = document.querySelector('.board-wrapper'),
          board = document.getElementById('board');
      var avail = wrapper.clientHeight, need = 0;
      document.querySelectorAll('.column').forEach(function(c){ if(c.scrollHeight>need) need=c.scrollHeight; });
      board.style.transform = 'scale('+ Math.min(1, avail/need) +')';
    }

    function showModal(item) {
      var m = document.getElementById('modal');
      m.style.display = 'block';
      m.innerHTML = '<div class="modal">'+
        '<div class="modal-content">'+
        '<div class="close" onclick="hideModal()">‚úï</div>'+
        '<h3>'+item.name+'</h3>'+
        '<div><strong>≈†ifra:</strong> '+item.product_code+'</div>'+
        '<div><strong>Status:</strong> '+item.status+'</div>'+
        '<div><strong>Proizvodnja:</strong> '+item.proizvodnja+'</div>'+
        '<div><strong>Dobavljaƒç:</strong> '+item.dobavljac+'</div>'+
        '<div><strong>Iskrojeno:</strong> '+item.iskrojeno+'</div>'+
        '<div><strong>Jedin. cena:</strong> '+item.unit_price.toFixed(2)+
        '</div><div><strong>Ukupno:</strong> '+item.total_price.toFixed(2)+
        '</div><div><strong>Datum objave:</strong> '+(item.datum_objave||'-')+
        '</div><div><strong>Days since publish:</strong> '+(item.days_since_publish||0)+'d'+
        '</div><div><strong>Slikano:</strong> '+(item.slikan?'Da':'Ne')+
        '</div></div></div>';
    }
    function hideModal() {
      var m = document.getElementById('modal');
      m.innerHTML = '';
      m.style.display = 'none';
    }

    document.getElementById('reloadBtn').onclick = function() {
      logEl.textContent = '--- console log ---';
      fetchAndRender();
    };
    window.onresize = adjustScale;

    // initial load
    fetchAndRender();
    setInterval(fetchAndRender, 10 * 60 * 1000);
  </script>
</body>
</html>