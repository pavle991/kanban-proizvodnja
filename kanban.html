<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="utf-8" />
  <title>Kanban proizvodnje</title>
  <meta http-equiv="refresh" content="600">
  <style>
    html { font-size: 14px; }
    body { font-family: system-ui,-apple-system,BlinkMacSystemFont,sans-serif; margin:0; padding:10px; background:#f0f2f5; }
    h2 { margin-top:0; font-size:1.5rem; }
    .status-banner { padding:6px 10px; margin-bottom:8px; border-radius:6px; background:#e6f7ff; border:1px solid #40a9ff; font-size:1rem; }
    .board-wrapper { width:100%; height: calc(100vh - 80px); overflow:hidden; }
    .board { display: flex; gap:8px; transform-origin: top left; }
    .column { flex:1; background:#e8eef5; border-radius:6px; display:flex; flex-direction:column; padding:6px; }
    .col-header { font-weight: bold; margin-bottom:4px; flex:0 0 auto; font-size:0.9rem; }
    .col-header-top { display:flex; justify-content: space-between; align-items: baseline; }
    .cards { flex:1; }
    .card {
      background:#fff; border-radius:6px; padding:6px; margin-bottom:6px;
      box-shadow:0 1px 3px rgba(0,0,0,0.1); position: relative; cursor:pointer;
      color:#1f2937; font-size:0.85rem; display:flex; align-items:center;
      justify-content:center; height:40px;
    }
    .slikano-badge {
      position:absolute; top:4px; left:4px; display:flex; align-items:center;
      gap:4px; background:rgba(255,255,255,0.9); padding:2px 6px; border-radius:999px;
      font-size:0.75rem; font-weight:600;
    }
    .slikano-dot { width:8px; height:8px; border-radius:50%; background:#28a745; display:inline-block; margin-right:4px; }
    .small { font-size:0.75rem; color:#222; margin-left:4px; }
    .modal {
      position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);
      display:flex; align-items:center; justify-content:center; z-index:10;
    }
    .modal-content {
      background:#fff; border-radius:6px; padding:16px; width:90%; max-width:600px;
      position: relative; box-shadow:0 8px 20px rgba(0,0,0,0.1); font-size:0.85rem;
    }
    .close { position:absolute; top:8px; right:8px; cursor:pointer; font-size:1.2rem; }
    .urgent { outline: 2px solid #ff9f1a; }
    .done { opacity:0.8; }
  </style>
</head>
<body>
  <h2>Kanban proizvodnje</h2>
  <div class="status-banner" id="status-banner">Uƒçitavanje...</div>
  <div class="board-wrapper">
    <div class="board" id="board">
      <div class="column" data-status="Proizvodnja">
        <div class="col-header">
          <div class="col-header-top">
            <div>Proizvodnja</div>
            <div class="column-count" id="count-Proizvodnja"></div>
          </div>
          <div class="summary" id="summary-Proizvodnja"></div>
          <div class="breakdown" id="breakdown-Proizvodnja"></div>
        </div>
        <div class="cards"></div>
      </div>
      <div class="column" data-status="Vez">
        <div class="col-header">
          <div class="col-header-top">
            <div>Vez</div>
            <div class="column-count" id="count-Vez"></div>
          </div>
          <div class="summary" id="summary-Vez"></div>
          <div class="breakdown" id="breakdown-Vez"></div>
        </div>
        <div class="cards"></div>
      </div>
      <div class="column" data-status="Pakovanje">
        <div class="col-header">
          <div class="col-header-top">
            <div>Pakovanje</div>
            <div class="column-count" id="count-Pakovanje"></div>
          </div>
          <div class="summary" id="summary-Pakovanje"></div>
          <div class="breakdown" id="breakdown-Pakovanje"></div>
        </div>
        <div class="cards"></div>
      </div>
      <div class="column" data-status="Magacin">
        <div class="col-header">
          <div class="col-header-top">
            <div>Magacin</div>
            <div class="column-count" id="count-Magacin"></div>
          </div>
          <div class="summary" id="summary-Magacin"></div>
          <div class="breakdown" id="breakdown-Magacin"></div>
        </div>
        <div class="cards"></div>
      </div>
      <div class="column" data-status="Nedefinisano">
        <div class="col-header">
          <div class="col-header-top">
            <div>Nedefinisano</div>
            <div class="column-count" id="count-Nedefinisano"></div>
          </div>
          <div class="summary" id="summary-Nedefinisano"></div>
          <div class="breakdown" id="breakdown-Nedefinisano"></div>
        </div>
        <div class="cards"></div>
      </div>
    </div>
  </div>

  <div id="modal" style="display:none;"></div>

  <script>
    const endpoint = "https://script.google.com/macros/s/AKfycbwhKEBafSBhrjNYc5oAosp6kRW4q0aInuTBt-tAZKdXARZskavi1qJdYWJRuLLRZnpTmw/exec";

    function colorFromString(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
        hash &= hash;
      }
      const h = Math.abs(hash) % 360;
      return `hsl(${h}, 55%, 85%)`;
    }

    async function fetchAndRender() {
      try {
        const res = await fetch(endpoint + '?_=' + Date.now());
        const data = await res.json();
        if (!data.items) {
          document.getElementById('status-banner').textContent = 'Gre≈°ka: nema items polja u JSON-u';
          return;
        }

        const statuses = ['Proizvodnja','Vez','Pakovanje','Magacin','Nedefinisano'];
        const counts = { Proizvodnja:0, Vez:0, Pakovanje:0, Magacin:0, Nedefinisano:0 };
        const totalIskrojeno = { Proizvodnja:0, Vez:0, Pakovanje:0, Magacin:0, Nedefinisano:0 };
        const slikanCount = { Proizvodnja:0, Vez:0, Pakovanje:0, Magacin:0, Nedefinisano:0 };
        const breakdown = { Proizvodnja:{}, Vez:{}, Pakovanje:{}, Magacin:{}, Nedefinisano:{} };
        const placed = new Set();

        statuses.forEach(s => {
          document.querySelector(`[data-status="${s}"] .cards`).innerHTML = '';
          document.getElementById('count-'+s).textContent = '';
          document.getElementById('summary-'+s).textContent = '';
          document.getElementById('breakdown-'+s).textContent = '';
        });

        data.items.forEach(item => {
          const statusRaw = item.status?.trim() || 'Nedefinisano';
          const status = statuses.includes(statusRaw) ? statusRaw : 'Nedefinisano';
          if (placed.has(item.product_code)) return;
          placed.add(item.product_code);
          counts[status]++;
          totalIskrojeno[status] += Number(item.iskrojeno) || 0;
          if (item.slikan) slikanCount[status]++;
          const prod = item.proizvodnja || 'Nepoznato';
          breakdown[status][prod] = (breakdown[status][prod]||0) + (Number(item.iskrojeno)||0);

          const colWrapper = document.querySelector(`[data-status="${status}"] .cards`);
          const card = document.createElement('div'); card.className = 'card';
          if (item.proizvodnja) card.style.background = colorFromString(item.proizvodnja);
          if (item.alert) card.classList.add('urgent');
          if (status === 'Magacin') card.classList.add('done');

          // Ikonica, naziv i broj dana
          const nameEl = document.createElement('div');
          const icon = item.slikan ? 'üì∑' : 'üö´üì∑';
          const days = item.days_since_publish || 0;
          nameEl.innerHTML = `${icon} <strong>${item.name}</strong><span class="small">${days}d</span>`;
          card.appendChild(nameEl);

          card.addEventListener('click', () => showModal(item));
          colWrapper.appendChild(card);
        });

        adjustScale();
        statuses.forEach(s => {
          document.getElementById('count-'+s).textContent = `(${counts[s]})`;
          document.getElementById('summary-'+s).textContent = `Ukupno iskrojeno: ${totalIskrojeno[s]}, Slikano: ${slikanCount[s]}`;
          const parts = [];
          for (const p in breakdown[s]) parts.push(`${p}: ${breakdown[s][p]}`);
          document.getElementById('breakdown-'+s).textContent = parts.join(' ‚Ä¢ ');
        });
        document.getElementById('status-banner').textContent = `Uƒçitano ${placed.size} proizvoda. Poslednje osve≈æenje: ${new Date().toLocaleTimeString('sr-RS')}.`;
      } catch (err) {
        console.error('Gre≈°ka pri fetch-u:', err);
        document.getElementById('status-banner').textContent = `Fetch error: ${err.message}`;
      }
    }

    function adjustScale(){
      const wrapper = document.querySelector('.board-wrapper'),
            board = document.getElementById('board');
      const availableH = wrapper.clientHeight;
      let neededH = 0;
      document.querySelectorAll('.column').forEach(col => {
        neededH = Math.max(neededH, col.scrollHeight);
      });
      const scale = Math.min(1, availableH / neededH);
      board.style.transform = `scale(${scale})`;
    }

    window.addEventListener('resize', adjustScale);
    fetchAndRender();
    setInterval(fetchAndRender, 10 * 60 * 1000);

    function showModal(item) {
      const modal = document.getElementById('modal');
      modal.style.display = 'block';
      modal.innerHTML = `
        <div class="modal">
          <div class="modal-content">
            <div class="close" onclick="hideModal()">‚úï</div>
            <h3>${item.name}</h3>
            <div><strong>≈†ifra:</strong> ${item.product_code}</div>
            <div><strong>Status:</strong> ${item.status}</div>
            <div><strong>Proizvodnja:</strong> ${item.proizvodnja}</div>
            <div><strong>Dobavljaƒç:</strong> ${item.dobavljac}</div>
            <div><strong>Iskrojeno:</strong> ${item.iskrojeno}</div>
            <div><strong>Jedin. cena:</strong> ${item.unit_price.toFixed(2)}</div>
            <div><strong>Ukupno:</strong> ${item.total_price.toFixed(2)}</div>
            <div><strong>Datum objave:</strong> ${item.datum_objave || '-'}</div>
            <div><strong>Days since publish:</strong> ${item.days_since_publish || 0}d</div>
            <div><strong>Slikano:</strong> ${item.slikan ? 'Da' : 'Ne'}</div>
          </div>
        </div>`;
    }
    function hideModal() {
      const m = document.getElementById('modal');
      m.innerHTML = '';
      m.style.display = 'none';
    }
  </script>
</body>
</html>