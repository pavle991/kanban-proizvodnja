<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="utf-8" />
  <title>Kanban proizvodnje</title>
  <meta http-equiv="refresh" content="600">
  <style>
    html { font-size: 14px; }
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; margin:0; padding:10px; background:#f0f2f5; }
    .header { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
    h2 { margin:0; font-size:1.5rem; }
    .controls { display:flex; align-items:center; gap:8px; }
    .controls button { padding:6px 12px; font-size:0.9rem; cursor:pointer; }
    .status-banner { display:inline-block; padding:6px 10px; border-radius:6px; background:#e6f7ff; border:1px solid #40a9ff; font-size:1rem; }
    .legend { display:flex; flex-wrap:wrap; gap:6px; }
    .legend-item { display:flex; align-items:center; padding:4px 8px; border-radius:4px; background:#fff; border:2px solid; font-size:0.9rem; cursor:pointer; }
    .legend-item.active { box-shadow:0 0 0 2px #000 inset; }
    .legend-color { width:12px; height:12px; border-radius:2px; margin-right:6px; }
    .filter-info { margin:8px 0; font-size:0.9rem; background:#fff; padding:8px; border-radius:4px; box-shadow:0 1px 3px rgba(0,0,0,0.1); display:none; }
    .board-wrapper { width:100%; height: calc(100vh - 320px); overflow:hidden; }
    .board { display: flex; gap:8px; transform-origin: top left; }
    .column { flex:1; background:#e8eef5; border-radius:6px; display:flex; flex-direction:column; padding:6px; }
    .col-header { font-weight: bold; margin-bottom:4px; flex:0 0 auto; font-size:0.9rem; cursor:pointer; }
    .col-header:hover { background:rgba(0,0,0,0.05); }
    .col-header-top { display:flex; justify-content: space-between; align-items: baseline; }
    .cards { flex:1; display:grid; grid-template-columns:1fr 1fr; gap:6px; }
    .card { background:#fff; border-radius:6px; padding:6px; box-shadow:0 1px 3px rgba(0,0,0,0.1); position: relative; cursor:pointer; color:#1f2937; font-size:0.85rem; display:flex; align-items:center; justify-content:center; height:40px; }
    .small { font-size:0.75rem; color:#222; margin-left:4px; }
    .urgent { outline:2px solid #ff9f1a; }
    .done { opacity:0.8; }
    .modal, .status-modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:10; }
    .modal-content, .status-content { background:#fff; border-radius:6px; padding:16px; width:90%; max-width:600px; position: relative; box-shadow:0 8px 20px rgba(0,0,0,0.1); font-size:0.85rem; }
    .close { position:absolute; top:8px; right:8px; cursor:pointer; font-size:1.2rem; }
  </style>
</head>
<body>
  <div class="header">
    <h2>Kanban proizvodnje</h2>
    <div class="controls">
      <button id="reloadBtn">Uƒçitaj ponovo</button>
      <span class="status-banner" id="status-banner">Uƒçitavanje‚Ä¶</span>
      <div class="legend" id="legend"></div>
    </div>
  </div>

  <div id="filterInfo" class="filter-info"></div>

  <div class="board-wrapper">
    <div class="board" id="board">
      <div class="column" data-status="Proizvodnja">
        <div class="col-header" onclick="showStatusInfo('Proizvodnja')">
          <div class="col-header-top">
            <div>Proizvodnja</div>
            <div class="column-count" id="count-Proizvodnja"></div>
          </div>
        </div>
        <div class="cards"></div>
      </div>
      <div class="column" data-status="Vez">
        <div class="col-header" onclick="showStatusInfo('Vez')">
          <div class="col-header-top">
            <div>Vez</div>
            <div class="column-count" id="count-Vez"></div>
          </div>
        </div>
        <div class="cards"></div>
      </div>
      <div class="column" data-status="Pakovanje">
        <div class="col-header" onclick="showStatusInfo('Pakovanje')">
          <div class="col-header-top">
            <div>Pakovanje</div>
            <div class="column-count" id="count-Pakovanje"></div>
          </div>
        </div>
        <div class="cards"></div>
      </div>
      <div class="column" data-status="Magacin">
        <div class="col-header" onclick="showStatusInfo('Magacin')">
          <div class="col-header-top">
            <div>Magacin</div>
            <div class="column-count" id="count-Magacin"></div>
          </div>
        </div>
        <div class="cards"></div>
      </div>
    </div>
  </div>

  <div id="modal" class="modal" style="display:none;"></div>
  <div id="statusModal" class="status-modal" style="display:none;"></div>

  <script>
    var endpoint = "https://script.google.com/macros/s/AKfycbwhKEBafSBhrjNYc5oAosp6kRW4q0aInuTBt-tAZKdXARZskavi1qJdYWJRuLLRZnpTmw/exec";
    var allItems = [];

    function fetchAndRender() {
      document.getElementById('status-banner').textContent = 'Uƒçitavanje...';
      var xhr = new XMLHttpRequest();
      xhr.open('GET', endpoint + '?_=' + Date.now(), true);
      xhr.onload = function() {
        if (xhr.status === 200) {
          var data = JSON.parse(xhr.responseText);
          allItems = data.items;
          buildLegend(allItems);
          renderBoard(allItems);
          document.getElementById('status-banner').textContent = 'Uƒçitano ' + allItems.length + ' proizvoda.';
        } else {
          document.getElementById('status-banner').textContent = 'Gre≈°ka status: ' + xhr.status;
        }
      };
      xhr.onerror = function() {
        document.getElementById('status-banner').textContent = 'Gre≈°ka XHR';
      };
      xhr.send();
    }

    function buildLegend(items) {
      var counts = {'Sve': items.length};
      items.forEach(i => {
        counts[i.proizvodnja] = (counts[i.proizvodnja]||0) + 1;
      });
      var legend = document.getElementById('legend');
      legend.innerHTML = '';
      ['Sve'].concat(Object.keys(counts).filter(k=>k!=='Sve')).forEach(prod => {
        var el = document.createElement('div');
        el.className = 'legend-item' + (window.currentFilter===prod ? ' active' : '');
        var color = prod==='Sve' ? '#000' : colorFromString(prod);
        el.style.borderColor = color;
        el.innerHTML = '<div class="legend-color" style="background:'+color+'"></div>'+prod+' ('+counts[prod]+')';
        el.onclick = ()=> {
          window.currentFilter = prod;
          document.getElementById('filterInfo').style.display = 'none';
          renderBoard(allItems);
        };
        legend.appendChild(el);
      });
    }

    function renderBoard(items) {
      var statuses = ['Proizvodnja','Vez','Pakovanje','Magacin'];
      statuses.forEach(s=> {
        document.querySelector('[data-status="'+s+'"] .cards').innerHTML = '';
      });
      items.forEach(item => {
        if (window.currentFilter && window.currentFilter!=='Sve' && item.proizvodnja!==window.currentFilter) return;
        var status = item.status && item.status.trim();
        if (!statuses.includes(status)) return;
        var card = document.createElement('div');
        card.className = 'card';
        card.style.background = colorFromString(item.proizvodnja);
        if (item.alert) card.classList.add('urgent');
        if (status==='Magacin') card.classList.add('done');
        card.innerHTML = (item.slikan?'üì∑':'üö´üì∑')+' <strong>'+item.name+'</strong><span class="small">'+item.days_since_publish+'d</span>';
        card.onclick = ()=> showModal(item);
        document.querySelector('[data-status="'+status+'"] .cards').appendChild(card);
      });
      statuses.forEach(s=>{
        document.getElementById('count-'+s).textContent = '(' + document.querySelectorAll('[data-status="'+s+'"] .card').length + ')';
      });
      adjustScale();
    }

    function showStatusInfo(status) {
      var items = allItems.filter(i => i.status===status);
      if (!items.length) return;
      var total = items.length;
      var isk = items.reduce((a,i) => a + i.iskrojeno, 0);
      var sl = items.filter(i => i.slikan).length;
      var totalValue = items.reduce((a,i) => a + i.total_price, 0);
      var k = Math.round(totalValue/1000) + 'k';
      var modal = document.getElementById('statusModal');
      modal.innerHTML = '<div class="status-content">' +
        '<div class="close" onclick="hideStatus()">‚úï</div>' +
        '<h3>'+status+' ‚Äì Statistika</h3>' +
        '<p>Ukupno artikala: '+total+'</p>' +
        '<p>Ukupno iskrojeno: '+isk+'</p>' +
        '<p>Slikano: '+sl+'</p>' +
        '<p>Ukupna vrednost: '+k+'</p>' +
      '</div>';
      modal.style.display = 'flex';
    }

    function hideStatus() {
      document.getElementById('statusModal').style.display = 'none';
    }

    function showModal(item) {
      var m = document.getElementById('modal');
      m.innerHTML = '<div class="modal-content">' +
        '<div class="close" onclick="hideModal()">‚úï</div>' +
        '<h3>'+item.name+'</h3>' +
        '<p><strong>≈†ifra:</strong> '+item.product_code+'</p>' +
        '<p><strong>Status:</strong> '+item.status+'</p>' +
        '<p><strong>Proizvodnja:</strong> '+item.proizvodnja+'</p>' +
        '<p><strong>Dobavljaƒç:</strong> '+item.dobavljac+'</p>' +
        '<p><strong>Iskrojeno:</strong> '+item.iskrojeno+'</p>' +
        '<p><strong>Ukupno:</strong> '+item.total_price.toFixed(2)+'</p>' +
        '<p><strong>Datum objave:</strong> '+item.datum_objave+'</p>' +
        '<p><strong>Slikano:</strong> '+(item.slikan?'Da':'Ne')+'</p>' +
      '</div>';
      m.style.display = 'flex';
    }

    function hideModal() {
      document.getElementById('modal').style.display = 'none';
    }

    function colorFromString(str) {
      var h=0;
      for(var i=0;i<str.length;i++){ h = str.charCodeAt(i) + ((h<<5)-h); h&=h; }
      return 'hsl(' + (Math.abs(h)%360) + ',55%,85%)';
    }

    function adjustScale() {
      var w = document.querySelector('.board-wrapper'),
          b = document.getElementById('board'),
          avail = w.clientHeight, need = 0;
      document.querySelectorAll('.column').forEach(c => {
        if (c.scrollHeight > need) need = c.scrollHeight;
      });
      b.style.transform = 'scale(' + Math.min(1, avail/need) + ')';
    }

    document.getElementById('reloadBtn').onclick = fetchAndRender;
    window.onresize = adjustScale;
    window.currentFilter = 'Sve';
    fetchAndRender();
    setInterval(fetchAndRender, 600000);
  </script>
</body>
</html>